<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>حفل تخرج طلاب ثانوية عبدالعزيز بن باز</title>
  <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #fdfbfb, #ebedee);
      margin: 0;
      padding: 2rem;
      text-align: center;
      color: #333;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 1rem;
    }
    .container {
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    video {
      width: 100%;
      border-radius: 10px;
    }
    .info, .status {
      text-align: right;
      font-size: 1.1rem;
      margin-top: 1rem;
    }
    .status.valid { color: green; }
    .status.invalid { color: red; }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:hover { background-color: #2980b9; }
  </style>
</head>
<body>
  <h1>حفل تخرج طلاب ثانوية عبدالعزيز بن باز 2025</h1>
  <div class="container">
    <video id="preview"></video>
    <div class="info" id="invitation-info"></div>
    <div class="status" id="status"></div>
    <form id="use-form" method="POST" style="display: none;">
      <input type="hidden" id="hidden-id" name="id">
      <button type="submit">تعليم الدعوة كمستخدمة</button>
    </form>
  </div>

  <audio id="success-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

  <script>
    let scanner = new Instascan.Scanner({ video: document.getElementById('preview'), mirror: false });
    let lastScanned = "";

    scanner.addListener('scan', function (content) {
      if (content === lastScanned) return;
      lastScanned = content;
      console.log("✅ تم قراءة QR:", content);

      let uuid = "";
      try {
        if (content.includes("?id=")) {
          const url = new URL(content);
          uuid = url.searchParams.get("id");
        } else if (content.match(/^[0-9a-fA-F-]{36}$/)) {
          uuid = content;
        }
      } catch (e) {
        console.error("❌ خطأ في تحليل QR:", e);
      }

      if (uuid) {
        fetch(`/api/verify?id=${uuid}`)
          .then(res => res.json())
          .then(data => {
            document.getElementById("hidden-id").value = uuid;
            document.getElementById("use-form").style.display = data.name ? "block" : "none";
            document.getElementById("invitation-info").innerHTML = data.name ? `
              <p><strong>الطالب:</strong> ${data.name}</p>
              <p><strong>رقم الهوية:</strong> ${data.national_id}</p>
            ` : "";
            document.getElementById("status").textContent = data.name ? (data.used ? "تم استخدامها" : "صالحة") : "غير موجود";
            document.getElementById("status").className = "status " + (data.name ? (data.used ? "invalid" : "valid") : "invalid");
            if (data.name && !data.used) document.getElementById("success-sound").play();
          });
      } else {
        document.getElementById("status").textContent = "رمز غير صالح";
        document.getElementById("status").className = "status invalid";
      }
    });

    Instascan.Camera.getCameras().then(function (cameras) {
      if (cameras.length > 0) {
        // محاولة اختيار الكاميرا الخلفية (عادة تكون الأخيرة في القائمة)
        let backCamera = cameras.find(camera => camera.name.toLowerCase().includes('back')) || cameras[cameras.length - 1];
        scanner.start(backCamera);
      } else {
        alert('لا توجد كاميرا متاحة');
      }
    }).catch(function (e) {
      console.error(e);
    });
  </script>
</body>
</html>
